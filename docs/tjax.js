/**
 * tjax
 * @version v1.1.0
 * @link https://github.com/totoraj930/tjax
 * @license MIT
 */
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Tjax=function(){function Tjax(options){_classCallCheck(this,Tjax);this._options={areas:["body"],wait:0,changeTitle:true,loadScript:true,controlScroll:true,waitPopState:true,onErrorNotMove:false};this._objExtend(this._options,options);this._eventPrefix="tjax:";this._req=null;this._reqTime=0;this._task=null;this._active=this.isSupported();this._onPopStateListener={that:this,handleEvent:this._onPopState};this._init()}_createClass(Tjax,[{key:"setOptions",value:function setOptions(options){this._objExtend(this._options,options);this._init()}},{key:"_init",value:function _init(){if(!this._active)return;var ops=this._options;window.history.scrollRestoration=ops.controlScroll?"manual":"auto";window.removeEventListener("popstate",this._onPopStateListener);window.addEventListener("popstate",this._onPopStateListener,true)}},{key:"isSupported",value:function isSupported(){if(!window.history||!window.history.pushState||!window.history.replaceState||!DOMParser){return false}try{new DOMParser().parseFromString("","text/html")}catch(err){return false}return true}},{key:"load",value:function load(path){if(!this._active){return false}this._getHtml(path);return true}},{key:"_replaceHtml",value:function _replaceHtml(htmlString,path,fromPopstate,scrollY){if(!fromPopstate){var stateObj={scrollY:window.pageYOffset,href:window.location.href};window.history.replaceState(stateObj,null,window.location.href);window.history.pushState(null,null,path)}var that=this,wait=this._options.wait-(new Date().getTime()-this._reqTime);if(wait<0||!this._options.waitPopState&&fromPopstate){wait=0}var parser=new DOMParser,dummyDoc=parser.parseFromString(htmlString,"text/html");this._task=new TjaxTask(wait,function(){that._onWaitEnd.call(that,dummyDoc,scrollY)})}},{key:"_onPopState",value:function _onPopState(event){event.preventDefault();var that=this.that;if(!that._active)return;var scrollY;if(that._options.controlScroll&&event.state){scrollY=event.state.scrollY}that._getHtml(window.location.href,true,scrollY);return false}},{key:"_onWaitEnd",value:function _onWaitEnd(dummyDoc,scrollY){var areas=this._options.areas;if(this._options.changeTitle){document.title=dummyDoc.title}for(var i=0;i<areas.length;i++){var query=areas[i],targetElm=document.querySelector(query),newElm=dummyDoc.querySelector(query);if(!newElm||!targetElm)continue;var oldAttrs=targetElm.attributes,newAttrs=newElm.attributes;for(var n=0;n<oldAttrs.length;n++){targetElm.removeAttribute(oldAttrs[n].name)}for(var n=0;n<newAttrs.length;n++){targetElm.setAttribute(newAttrs[n].name,newAttrs[n].value)}targetElm.innerHTML=newElm.innerHTML;if(this._options.loadScript){this._loadScript(targetElm)}}if(this._options.controlScroll){if(isFinite(scrollY)){window.scroll(0,scrollY)}else{window.scroll(0,0)}}this._trigger("end")}},{key:"_loadScript",value:function _loadScript(elm){var scripts=elm.querySelectorAll("script");for(var i=0;i<scripts.length;i++){var oldScript=scripts[i];var newScript=document.createElement("script");for(var n=0;n<oldScript.attributes.length;n++){var prop=oldScript.attributes[n];newScript.setAttribute(prop.name,prop.value)}newScript.innerHTML=oldScript.innerHTML;oldScript.parentNode.replaceChild(newScript,oldScript)}}},{key:"_getHtml",value:function _getHtml(path,fromPopstate,scrollTop){if(this._req){this._req.abort()}if(this._task){this._task.cancel();this._task=null}this._req=new XMLHttpRequest;var that=this,req=this._req;this._reqTime=new Date().getTime();req.open("GET",path);req.addEventListener("readystatechange",function(){if(4==req.readyState){if(req.status==200||req.status==304){that._replaceHtml(req.responseText,path,fromPopstate,scrollTop);that._req=null;that._trigger("loaded")}else{if(that._options.onErrorNotMove){that._trigger("error")}else{window.location=path}}that._loading=false}});req.send();this._trigger("start")}},{key:"_trigger",value:function _trigger(eventName){var event;if(document.createEvent){event=document.createEvent("Event")}else{event=document.createEventObject("Event")}event.initEvent(this._eventPrefix+eventName,true,true);if(document.dispatchEvent){document.dispatchEvent(event)}else{document.fireEvent(event)}}},{key:"_objExtend",value:function _objExtend(target){var arg=arguments,src,keys,key;for(var i=1;i<arg.length;i++){src=arg[i];if(src==undefined||src==null){continue}keys=Object.keys(src);for(var n=0;n<keys.length;n++){key=keys[n];target[key]=src[key]}}return target}}]);return Tjax}();var TjaxTask=function(){function TjaxTask(wait,callback){_classCallCheck(this,TjaxTask);this._timer=setTimeout(callback,wait)}_createClass(TjaxTask,[{key:"cancel",value:function cancel(){clearTimeout(this._timer)}}]);return TjaxTask}();