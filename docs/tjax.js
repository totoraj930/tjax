/**
 * tjax
 * @version v1.1.1
 * @link https://github.com/totoraj930/tjax
 * @license MIT
 */
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),Tjax=function(){function t(e){_classCallCheck(this,t),this._options={areas:["body"],wait:0,changeTitle:!0,loadScript:!0,controlScroll:!0,waitPopState:!0,onErrorNotMove:!1},this._objExtend(this._options,e),this._eventPrefix="tjax:",this._req=null,this._reqTime=0,this._task=null,this._active=this.isSupported(),this._onPopStateListener={that:this,handleEvent:this._onPopState},this._init()}return _createClass(t,[{key:"setOptions",value:function(t){this._objExtend(this._options,t),this._init()}},{key:"_init",value:function(){if(this._active){var t=this._options;window.history.scrollRestoration=t.controlScroll?"manual":"auto",window.removeEventListener("popstate",this._onPopStateListener),window.addEventListener("popstate",this._onPopStateListener,!0)}}},{key:"isSupported",value:function(){if(!(window.history&&window.history.pushState&&window.history.replaceState&&DOMParser))return!1;try{(new DOMParser).parseFromString("","text/html")}catch(t){return!1}return!0}},{key:"load",value:function(t){return!!this._active&&(this._getHtml(t),!0)}},{key:"_replaceHtml",value:function(t,e,n,i){if(!n){var r={scrollY:window.pageYOffset,href:window.location.href};window.history.replaceState(r,null,window.location.href),window.history.pushState(null,null,e)}var o=this,a=this._options.wait-((new Date).getTime()-this._reqTime);(a<0||!this._options.waitPopState&&n)&&(a=0);var s=(new DOMParser).parseFromString(t,"text/html");this._task=new TjaxTask(a,function(){o._onWaitEnd.call(o,s,i)})}},{key:"_onPopState",value:function(t){t.preventDefault();var e=this.that;if(e._active){var n;return e._options.controlScroll&&t.state&&(n=t.state.scrollY),e._getHtml(window.location.href,!0,n),!1}}},{key:"_onWaitEnd",value:function(t,e){var n=this._options.areas;this._options.changeTitle&&(document.title=t.title);for(var i=0;i<n.length;i++){var r=n[i],o=document.querySelector(r),a=t.querySelector(r);if(a&&o){for(var s=o.attributes,l=a.attributes,c=0;c<s.length;c++)o.removeAttribute(s[c].name);for(c=0;c<l.length;c++)o.setAttribute(l[c].name,l[c].value);o.innerHTML=a.innerHTML,this._options.loadScript&&this._loadScript(o)}}this._options.controlScroll&&(isFinite(e)?window.scroll(0,e):window.scroll(0,0)),this._trigger("end")}},{key:"_loadScript",value:function(t){for(var e=t.querySelectorAll("script"),n=0;n<e.length;n++){for(var i=e[n],r=document.createElement("script"),o=0;o<i.attributes.length;o++){var a=i.attributes[o];r.setAttribute(a.name,a.value)}r.innerHTML=i.innerHTML,i.parentNode.replaceChild(r,i)}}},{key:"_getHtml",value:function(t,e,n){this._req&&this._req.abort(),this._task&&(this._task.cancel(),this._task=null),this._req=new XMLHttpRequest;var i=this,r=this._req;this._reqTime=(new Date).getTime(),r.open("GET",t),r.addEventListener("readystatechange",function(){4==r.readyState&&(200==r.status||304==r.status?(i._replaceHtml(r.responseText,t,e,n),i._req=null,i._trigger("loaded")):i._options.onErrorNotMove?i._trigger("error"):window.location=t,i._loading=!1)}),r.send(),this._trigger("start")}},{key:"_trigger",value:function(t){var e;(e=document.createEvent?document.createEvent("Event"):document.createEventObject("Event")).initEvent(this._eventPrefix+t,!0,!0),document.dispatchEvent?document.dispatchEvent(e):document.fireEvent(e)}},{key:"_objExtend",value:function(t){for(var e,n,i,r=arguments,o=1;o<r.length;o++)if(void 0!=(e=r[o])&&null!=e){n=Object.keys(e);for(var a=0;a<n.length;a++)t[i=n[a]]=e[i]}return t}}]),t}(),TjaxTask=function(){function t(e,n){_classCallCheck(this,t),this._timer=setTimeout(n,e)}return _createClass(t,[{key:"cancel",value:function(){clearTimeout(this._timer)}}]),t}();